<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Easbroidery — Editor</title>
  <link rel="preload" href="assets/logo.png" as="image">
  <link rel="stylesheet" href="styles.css">
</head>
<body class="editor-shell">
  <!-- Top Bar -->
  <header class="eb-topbar" role="banner">
    <div class="eb-topbar__left">
      <a href="index.html" class="eb-brand">
        <img src="assets/logo.png" alt="Easbroidery" class="eb-brand__logo">
        <span class="eb-brand__name">Easbroidery</span>
      </a>
    </div>
    <nav class="eb-menubar" aria-label="Editor menu">
      <button class="eb-menu__btn" data-action="file">File</button>
      <button class="eb-menu__btn" data-action="edit">Edit</button>
    </nav>
    <div class="eb-topbar__right">
      <button id="eb-save" class="eb-btn eb-btn--secondary" title="Save">Save</button>
      <button id="eb-export" class="eb-btn eb-btn--primary" title="Export">Export</button>
    </div>
  </header>

  <!-- Main Layout -->
  <main class="eb-layout" role="main">
    <!-- Left Rail -->
    <aside class="eb-rail" aria-label="Tools">
      <ul class="eb-tools" role="toolbar" aria-orientation="vertical">
        <li><button class="eb-tool" data-tool="select" aria-label="Select">Select</button></li>
        <li><button class="eb-tool" data-tool="brush"  aria-label="Brush">Brush</button></li>
        <li><button class="eb-tool" data-tool="eraser" aria-label="Eraser">Eraser</button></li>
        <li><button class="eb-tool" data-tool="wand"   aria-label="Magic Wand">Wand</button></li>
        <li><button class="eb-tool" data-tool="lasso"  aria-label="Lasso">Lasso</button></li>
        <li><button class="eb-tool" data-tool="text"   aria-label="Text">Text</button></li>
        <li><button class="eb-tool" data-tool="shapes" aria-label="Shapes">Shapes</button></li>
        <li><button class="eb-tool" data-tool="uploads" aria-label="Uploads">Uploads</button></li>
        <li><button class="eb-tool" data-tool="layers" aria-label="Layers">Layers</button></li>
      </ul>

      <!-- Loom preview card (mini) -->
      <section class="eb-loom" aria-label="Loom preview">
        <h2 class="eb-loom__title">Loom preview</h2>
        <div class="eb-loom__card">
          <canvas id="loomPreviewCanvas" width="160" height="160" aria-label="Mini hoop live preview"></canvas>
        </div>
        <button id="loomPreviewEnlarge" class="eb-btn eb-btn--ghost">Enlarge</button>
      </section>

      <!-- Mobile FAB (preview hidden as button) -->
      <button id="previewFab" class="eb-fab" aria-label="Open Loom preview" title="Preview">
        Preview
      </button>
    </aside>

    <!-- Stage -->
    <section class="eb-stage" aria-label="Editor canvas">
      <div class="eb-canvas-wrap">
        <!-- Rulers are visual only; your existing canvas remains -->
        <div class="eb-ruler eb-ruler--top"></div>
        <div class="eb-ruler eb-ruler--left"></div>
        <canvas id="mainCanvas" width="1600" height="1200" aria-label="Edit canvas"></canvas>
      </div>
    </section>

    <!-- Right Context Panel -->
    <aside class="eb-context" aria-label="Tool settings">
      <div id="contextContent">
        <!-- Populated by tool selection; your scripts can inject controls here -->
        <h3>Contextual settings for active tool</h3>
        <div id="contextMount"></div>
      </div>
    </aside>
  </main>

  <!-- Bottom Status Bar -->
  <footer class="eb-status" role="contentinfo">
    <div class="eb-status__group">
      <span id="statusZoom">Zoom 100%</span>
      <span id="statusHoop">4.0" × 4.0</span>
      <span id="statusStitches">0 stitches</span>
    </div>
    <button id="btnConvert" class="eb-btn eb-btn--primary">Convert</button>
  </footer>

  <!-- Enlarge Preview Modal -->
  <dialog id="previewModal" class="eb-modal" aria-label="Loom preview">
    <div class="eb-modal__head">
      <h4>Loom preview</h4>
      <button id="previewModalClose" class="eb-iconbtn" aria-label="Close">✕</button>
    </div>
    <div class="eb-modal__body">
      <canvas id="loomPreviewLarge" width="900" height="700" aria-label="Large hoop preview"></canvas>
    </div>
  </dialog>

  <!-- Existing runtime + scripts -->
  <script src="lib/ort.min.js"></script>
  <script src="app.js"></script>
  <script src="script.upload.js"></script>
  <script src="script.preview.js"></script>
  <script src="script.draw.js"></script>
  <script src="processing.js"></script>
  <script src="worker.js"></script>

  <!-- Small UI glue that calls existing functions if present -->
  <script>
    // Tool select -> try your existing setter
    document.querySelectorAll('.eb-tool').forEach(btn=>{
      btn.addEventListener('click', () => {
        const t = btn.dataset.tool;
        if (window.setActiveTool) { try { setActiveTool(t); } catch(e){} }
        if (window.Tools && typeof window.Tools.set==='function') { try { window.Tools.set(t);} catch(e){} }
        window.dispatchEvent(new CustomEvent('tool:select', {detail:{tool:t}}));
        document.querySelectorAll('.eb-tool').forEach(b=>b.classList.toggle('is-active', b===btn));
      });
    });

    // Convert button -> existing convert if present
    document.getElementById('btnConvert').addEventListener('click', ()=>{
      if (window.convertToEmbroidery) { try { convertToEmbroidery(); return; } catch(e){} }
      if (window.Processing && typeof Processing.convert==='function') { try { Processing.convert(); return; } catch(e){} }
      console.warn('Convert hook not found.');
    });

    // Status API for other scripts
    window.EditorUI = {
      setZoom(v){ document.getElementById('statusZoom').textContent = `Zoom ${v}%`; },
      setHoop(w,h){ document.getElementById('statusHoop').textContent = `${w}" × ${h}"`; },
      setStitches(n){ document.getElementById('statusStitches').textContent = `${n.toLocaleString()} stitches`; },
      refreshMini(){ if (window.renderLoomPreview) renderLoomPreview('loomPreviewCanvas'); }
    };

    // Preview open/close
    const openPreview = () => {
      const dlg = document.getElementById('previewModal');
      if (!dlg.open) dlg.showModal();
      if (window.renderLoomPreview) renderLoomPreview('loomPreviewLarge');
    };
    document.getElementById('loomPreviewEnlarge').addEventListener('click', openPreview);
    document.getElementById('previewFab').addEventListener('click', openPreview);
    document.getElementById('previewModalClose').addEventListener('click', () => {
      document.getElementById('previewModal').close();
    });

    // Keyboard toggle
    window.addEventListener('keydown', (e)=>{ if(e.key.toLowerCase()==='p') openPreview(); });

    // Initial mini render
    window.addEventListener('load', ()=> {
      if (window.renderLoomPreview) renderLoomPreview('loomPreviewCanvas');
    });
  </script>
</body>
</html>